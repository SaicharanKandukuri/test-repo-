on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - name: Clone repo
      uses: actions/checkout@v2
    - name: setup deps
      run: sudo appt update; sudo apt install axel binfmt-support qemu-user-static -y
    - name: clone fs
      run: axel https://cdimage.ubuntu.com/ubuntu-base/focal/daily/current/focal-base-armhf.tar.gz
    - name: extract fs
      run: mkdir -pv fs; sudo tar -xvpzf focal-base-armhf.tar.gz -C fs
    - name: Setup qemu
      run: sudo cp /bin/qemu-arm-static fs/bin ;sudo service binfmt-support start
    - name: mount fs
      run: sudo mount --rbind /dev fs/dev; sudo mount -t proc proc fs/proc;sudo mount -t sysfs /sys fs/sys
    - name: setup network
      run: sudo touch fs/etc/resolv.conf;echo nameserver 8.8.8.8 | sudo tee fs/etc/resolv.conf
    - name: fix up fs
      run: sudo cp -v payload/stage1.sh fs/stage1.sh; sudo cp -v payload/stage2.sh fs/stage2.sh; sudo chroot fs bash /stage1.sh; sudo chroot fs bash /stage2.sh
    - name: Desktop Environment xfce4/Xubuntu and essentials
      run: sudo cp -v payload/stage3.sh fs/stage3.sh;sudo chroot fs bash /stage3.sh
    - name: setupvnc
      run: sudo cp -v payload/stage4.sh fs/stage4.sh;sudo chroot fs bash /stage4.sh
    - name: cleanup
      run: sudo chroot fs apt clean
    - name: make tarbal
      run: sudo chroot fs tar -cvpzf /focal-armhf.tar.gz --exclude-caches-all --exclude=/dev/*  --exclude=/sys/* --exclude=/proc/* --exclude=/run/* --exclude=/tmp/* --exclude=/focal-armhf.tar.gz /* --one-file-system || true
    - name: upload artifact
      uses: actions/upload-artifact@v2
    with:
      name: focal-armhf.tar.gz
      path : |
        fs/focal-armhf.tar.gz
    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          Changes in this Release
          - First Change
          - Second Change
        draft: true
        prerelease: false
    - name: Upload release asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: fs/focal-armhf.tar.gz
        asset_name: focal-armhf.tar.gz
        asset_content_type: application/gzip
    - name: Publish release
      uses: StuYarrow/publish-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        id: ${{ steps.create_release.outputs.id }}
    
